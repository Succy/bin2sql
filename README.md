# MySQL binlog转Sql工具

## 简介

### 工具起源

​		一开始，我只想找一个工具去解析mysql的binlog，以便于不时之需恢复数据，首当其冲肯定是想到mysql官方都提供了哪些，因此最开始是研究mysqlbinlog这个工具的，但是后面发现，它只能指定到database级别，并不能到table级别，而且有时候我们不是很关心create/drop之类的sql，比较关心DML，甚至关心我能不能只过滤出来指定的表指定的类型的SQL语句。也正是由于这个原因，我在网上寻找了很多这方便的工具，总结一下网上的工具主要都是如下两方面的：

1、通过伪装成slave拉取binlog来进行处理。以[binlog2sql](https://github.com/danfengcao/binlog2sql)为代表.

2、直接解析binlog文件，然后对数据做二次过滤的，以mysqlbinlog和本程序为代表。

​		然而binlog2sql在我使用过程中，总得来说也还不错的，就是其运行有点慢，我就想能不能有一个工具可以直接解析binlog又能满足我的要求的？寻求了一圈之后我发现并没有很符合我的要求的，于是我打算自己写一个。一开始我并不打算使用Perl语言写的，因为我对这个语言不是很熟悉，我是想着用go或者python写的，但是在我用go和python写了一段时间之后，都发现在处理文本这块有些许不足，可能也是因为我的水平问题吧，因此我选择了Perl语言，简单看了下语法和网上的一些案例之后，就开始写了，Perl同时有着强大的正则表达式和能直接运行shell命令的强大特点让我在编写过程中节约了很多时间。

​		这个小工具采用了mysqlbinlog作为主要产生数据的工具，通过Perl调用mysqlbinlog获取到可读的binlog数据，然后再进行流式处理，从而达到目的，在目前我的使用过程中发现，这样的配合执行速度还是不错的。由于我的Perl水平实在是有限，程序也难免会有错误，如果发现有错误或者有更好的写法，欢迎issue和pr。



### 功能介绍

这是一款使用perl语言开发的mysql binlog转sql的工具，主要是弥补了`mysqlbinlog`这个自带的工具不能指定表名的不足，主要包含如下功能

+ 支持指定start-datetime和stop-datetime解析binlog。
+ 支持指定start-position和stop-position解析binlog。
+ 支持解析指定的databases、指定的tables。
+ 支持指定dml类型，仅支持`INSERT、UPDATE、DELETE`。
+ 支持`only-dml`属性，如果指定该属性，则不会输出dml以外的sql。
+ 支持闪回(flashback)
+ 支持获取远端服务器的Binlog


## 安装和配置

首先说明一下，我都是在Linux下测试的，并且也是针对Linux环境开发的，因为Perl语言在很多Linux发行版都内置，我所使用的是CentOS7，内置的Perl是5.16.3，如果想要在Windows下使用，请安装Perl语言环境，并且修改内部的mysqlbinlog为mysqlbinlog.exe（前提是mysqlbinlog.exe在环境变量内）。

> 特别注意：**MySQL Server一定要开启binlog，并且我使用的binlog_format是mixed，如果只是row的话，可能不行**

我测试的Mysql数据库版本是5.7.25 理论上>=5.6的版本都支持。不过我没有做过测试

下面是安装步骤：

```shell
1、克隆本项目到服务器本地
2、进入项目根目录并且授予可执行权限
cd bin2sql && chmod +x bin2sql
3、运行bin2sql
```

直接运行bin2sql会出现如下的帮助文档

```shell
MySQL Binlog to SQL
Options:
    -t, --tables=name           export tables in tablenames, deliminate by comma.
    -d, --database=name         List entries for just this database (local log only).

    --start-datetime=name       Start reading the binlog at first event having a datetime
                                equal or posterior to the argument; the argument must be
                                a date and time in the local time zone, in any format
                                accepted by the MySQL server for DATETIME and TIMESTAMP
                                types, for example: 2004-12-25 11:25:56 (you should
                                probably use quotes for your shell to set it properly).

    --start-position=#          Start reading the binlog at position N. Applies to the
                                first binlog passed on the command line.

    --stop-datetime=name        Stop reading the binlog at first event having a datetime
                                equal or posterior to the argument; the argument must be
                                a date and time in the local time zone, in any format
                                accepted by the MySQL server for DATETIME and TIMESTAMP
                                types, for example: 2004-12-25 11:25:56 (you should
                                probably use quotes for your shell to set it properly).

    --stop-position=#           Stop reading the binlog at position N. Applies to the
                                last binlog passed on the command line.

    --only-dml                  Only print dml sql, optional, default disabled.
    --sql-type                  Sql type you want to process, support INSERT, UPDATE, DELETE.
    -f, --binlog=name           Read from binlog file.
    --help                      Print help message.
```



## 用法示例

### 解析出指定database和table的sql

```shell
[root@centos7 binlog]# ./bin2sql -d demo -t cm_customer_address -f mysql-bin.000001 
# use command: mysqlbinlog -vv --base64-output=DECODE-ROWS --skip-gtids --database=demo mysql-bin.000001
#210419 22:42:37 server id 1  end_log_pos 658977717 CRC32 0x9b283851 	Query	thread_id=11	exec_time=0	error_code=0
DROP TABLE IF EXISTS `cm_customer_address` /* generated by server */;# at 658977717
#210419 22:42:37 server id 1  end_log_pos 658979301 CRC32 0xe620ca98 	Query	thread_id=11	exec_time=0	error_code=0
CREATE TABLE `cm_customer_address`  (
  `id` varchar(36) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NOT NULL COMMENT '主键',
  `create_by` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '创建人',
  `create_time` datetime(0) NULL DEFAULT NULL COMMENT '创建日期',
  `update_by` varchar(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '更新人',
  `update_time` datetime(0) NULL DEFAULT NULL COMMENT '更新日期',
  `sys_org_code` varchar(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '所属部门',
  `customer_id` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '顾客',
  `contact_name` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '联系人姓名',
  `contact_phone` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '联系电话',
  `id_card_no` varchar(32) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '身份证号',
  `address` varchar(256) CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT '地址',
  `tenant_id` int(10) NULL DEFAULT NULL COMMENT '租户',
  `del_flag` int(10) NULL DEFAULT NULL COMMENT '删除标识',
  PRIMARY KEY (`id`) USING BTREE
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_general_ci;# at 658979301
#210419 22:42:37 server id 1  end_log_pos 658980844 CRC32 0x2d8ad91b 	Query	thread_id=11	exec_time=0	error_code=0
INSERT INTO `cm_customer_address` VALUES ('1349180955680567298', 'admin', '2021-01-13 10:26:21', NULL, NULL, 'A04', '1349180487696904194', '李四', '13800000000', '450921000000000000', '广西柳州', 1, 0), ('1352146435533000705', 'admin', '2021-01-21 14:50:07', NULL, NULL, 'A04', '1349248206684430338', 'fewfe', NULL, NULL, NULL, 1, 0), ('1352436054396891137', 'admin', '2021-01-22 10:00:57', NULL, NULL, 'A04', '1352414040295444482', '测试', '13566544556', '36545625622566', '测试地址', 1, 0), ('1356772544144900098', 'admin', '2021-02-03 09:12:37', NULL, NULL, 'A04', '1356770656502579202', '杨明', '13800000000', '450212199502112026', '广西柳州柳北', 1, 0), ('1356773159994556417', 'admin', '2021-02-03 09:15:04', NULL, NULL, 'A04', '1356769739644502018', '王暗', '15578543050', '450212199501222569', '广西柳州柳北', 1, 0), ('1356773771477942273', 'admin', '2021-02-03 09:17:29', NULL, NULL, 'A04', '1356769246465654785', '李黄', '13800000000', '52103699958441201', '广西柳州柳北', 1, 0), ('1356774064303276034', 'admin', '2021-02-03 09:18:39', NULL, NULL, 'A04', '1356768576505282562', '卢杰', '13800000000', '56661261616661', '广西柳州柳北', 1, 0), ('1356892567127535618', 'admin', '2021-02-03 17:09:33', NULL, NULL, 'A04', '1356892171155877889', '云枫', '', NULL, NULL, 1, 0);# at 658980844
#210422  3:50:23 server id 1  end_log_pos 660779418 CRC32 0xedf2af29 	Query	thread_id=17	exec_time=0	error_code=0
UPDATE `demo`.`cm_customer_address` SET `address` = '广西柳州市城中区' WHERE `id` = '1356892567127535618';# at 660779418

```

### 解析出指定表指定dml类型的sql

```shell
# 解析insert语句
[root@centos7 binlog]# ./bin2sql -d demo -t cm_customer_address --sql-type insert -f mysql-bin.000001 
# use command: mysqlbinlog -vv --base64-output=DECODE-ROWS --skip-gtids --database=demo mysql-bin.000001
#210419 22:42:37 server id 1  end_log_pos 658980844 CRC32 0x2d8ad91b 	Query	thread_id=11	exec_time=0	error_code=0
INSERT INTO `cm_customer_address` VALUES ('1349180955680567298', 'admin', '2021-01-13 10:26:21', NULL, NULL, 'A04', '1349180487696904194', '李四', '13800000000', '450921000000000000', '广西柳州', 1, 0), ('1352146435533000705', 'admin', '2021-01-21 14:50:07', NULL, NULL, 'A04', '1349248206684430338', 'fewfe', NULL, NULL, NULL, 1, 0), ('1352436054396891137', 'admin', '2021-01-22 10:00:57', NULL, NULL, 'A04', '1352414040295444482', '测试', '13566544556', '36545625622566', '测试地址', 1, 0), ('1356772544144900098', 'admin', '2021-02-03 09:12:37', NULL, NULL, 'A04', '1356770656502579202', '杨明', '13800000000', '450212199502112026', '广西柳州柳北', 1, 0), ('1356773159994556417', 'admin', '2021-02-03 09:15:04', NULL, NULL, 'A04', '1356769739644502018', '王暗', '15578543050', '450212199501222569', '广西柳州柳北', 1, 0), ('1356773771477942273', 'admin', '2021-02-03 09:17:29', NULL, NULL, 'A04', '1356769246465654785', '李黄', '13800000000', '52103699958441201', '广西柳州柳北', 1, 0), ('1356774064303276034', 'admin', '2021-02-03 09:18:39', NULL, NULL, 'A04', '1356768576505282562', '卢杰', '13800000000', '56661261616661', '广西柳州柳北', 1, 0), ('1356892567127535618', 'admin', '2021-02-03 17:09:33', NULL, NULL, 'A04', '1356892171155877889', '云枫', '', NULL, NULL, 1, 0);# at 658980844

# 解析update语句
[root@centos7 binlog]# ./bin2sql -d demo -t cm_customer_address --sql-type update -f mysql-bin.000001 
# use command: mysqlbinlog -vv --base64-output=DECODE-ROWS --skip-gtids --database=demo mysql-bin.000001
#210422  3:50:23 server id 1  end_log_pos 660779418 CRC32 0xedf2af29 	Query	thread_id=17	exec_time=0	error_code=0
UPDATE `demo`.`cm_customer_address` SET `address` = '广西柳州市城中区' WHERE `id` = '1356892567127535618';# at 660779418
```



## 鸣谢

[binlog2sql](https://github.com/danfengcao/binlog2sql) 这个项目给我提供了我python版本的借鉴，虽然后面python版本的流产了。

[MySQL_Binlog_Table_Filter](https://github.com/sillydong/MySQL_Binlog_Table_Filter) 本工具借鉴了这个项目，由于我是Perl新手，这个项目给我提供了不少Perl相关写法借鉴。